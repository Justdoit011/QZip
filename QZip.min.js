/*QZip v1.0 by Qi Zhao*/var QZip;(function(g){var h;(function(e){var f=(function(){function f(a,b){this.index=0;this.length=a;if(b&&b>0)this.offset=b;else this.offset=0}f.prototype.byteAt=function(i){throw new Error("byteAt is not implemented.");};f.prototype.checkOffset=function(a){this.checkIndex(this.index+a)};f.prototype.checkIndex=function(a){if(this.length<a||a<0){throw new Error("End of data reached (data length = "+this.length+", asked index = "+(a)+"). Corrupted zip ?");}};f.prototype.setIndex=function(a,b){if(b)a-=this.offset;this.checkIndex(a);this.index=a};f.prototype.skip=function(n){this.setIndex(this.index+n)};f.prototype.lastIndexOfSignature=function(a,b,c){if(!b)b=this.length-4;else if(b>=this.length)b=this.length-4;if(!c)c=0;else if(c<0)c=0;g.ZipFile.writeLog("Search signature: "+c+" to "+b);var d=a.charCodeAt(0),sig1=a.charCodeAt(1),sig2=a.charCodeAt(2),sig3=a.charCodeAt(3);for(var i=b;i>=c;--i){if(this.byteAt(i)===d&&this.byteAt(i+1)===sig1&&this.byteAt(i+2)===sig2&&this.byteAt(i+3)===sig3){g.ZipFile.writeLog("Signature found in "+(b-i+1)+" try.");return i}}return-1};f.prototype.readInt=function(a){var b=0,i;this.checkOffset(a);for(i=this.index+a-1;i>=this.index;i--){b=(b<<8)+this.byteAt(i)}this.index+=a;return b>>>0};f.prototype.readInt64=function(){var a=this.readInt(4);var b=this.readInt(4);if(b===0)return a;return b*4294967296+a};f.prototype.readString=function(a){throw new Error("readString is not implemented.");};f.prototype.readDate=function(){var a=this.readInt(4);return new Date(((a>>25)&0x7f)+1980,((a>>21)&0x0f)-1,(a>>16)&0x1f,(a>>11)&0x1f,(a>>5)&0x3f,(a&0x1f)<<1)};f.prototype.dispose=function(){};f.CreateReader=function(a,b){if(typeof(ArrayBuffer)==="function"&&a instanceof ArrayBuffer){return new e.Uint8ArrayReader(new Uint8Array(a),b)}else if(typeof(a)==="string"){return new e.StringArrayReader(a,b)}throw new Error("Unsupported binary reader data type: "+typeof(a));};f.MAX_VALUE_32BITS=0xFFFFFFFF;return f})();e.BinaryReader=f})(h=g.Internal||(g.Internal={}))})(QZip||(QZip={}));var __extends=(this&&this.__extends)||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}__.prototype=b.prototype;d.prototype=new __()};var QZip;(function(f){var g;(function(d){var e=(function(c){__extends(e,c);function e(a,b){if(!a)throw new Error("Array buffer is empty.");this.data=a;c.call(this,a.length,b)}e.prototype.byteAt=function(i){return this.data.charCodeAt(i)};e.prototype.readString=function(a){if(a===0)return"";var b=this.data.substring(this.index,this.index+a);this.index+=a;return b};e.prototype.dispose=function(){if(this.data)this.data=null};return e})(d.BinaryReader);d.StringArrayReader=e})(g=f.Internal||(f.Internal={}))})(QZip||(QZip={}));var QZip;(function(m){var n;(function(j){var l=(function(h){__extends(l,h);function l(a,b){if(!a)throw new Error("Array buffer is empty.");this.data=a;h.call(this,a.length,b)}l.prototype.byteAt=function(i){return this.data[i]};l.prototype.readString=function(a){if(a===0)return"";var b=this.arrayLikeToString(this.data,this.index,this.index+a);this.index+=a;return b};l.prototype.arrayLikeToString=function(a,b,c){var d=65536;var f=[],len=c,type="uint8array",k=b,canUseApply=true;try{String.fromCharCode.apply(null,new Uint8Array(0))}catch(e){canUseApply=false}if(!canUseApply){var g="";for(var i=k;i<len;i++){g+=String.fromCharCode(a[i])}return g}while(k<len&&d>1){try{f.push(String.fromCharCode.apply(null,a.subarray(k,Math.min(k+d,len))));k+=d}catch(e){d=Math.floor(d/2)}}return f.join("")};l.prototype.dispose=function(){if(this.data)this.data=null};return l})(j.BinaryReader);j.Uint8ArrayReader=l})(n=m.Internal||(m.Internal={}))})(QZip||(QZip={}));var QZip;(function(j){var k;(function(g){var h=(function(){function h(a,b){this.zip64=false;this.isDir=false;this.zip64=b;this.readCentralPart(a)}h.prototype.readCentralPart=function(a){a.skip(2+2);this.bitFlag=a.readInt(2);a.skip(2);this.date=a.readDate();a.skip(4+4);this.uncompressedSize=a.readInt(4);var b=a.readInt(2);var c=a.readInt(2);var d=a.readInt(2);a.skip(2+2+4+4);if(this.isEncrypted()){throw new Error("Encrypted zip are not supported");}this.fileName=a.readString(b);if(this.useUTF8())this.fileName=this.decodeUTF8(this.fileName);else this.fileName=this.decodeASCII(this.fileName);if(this.fileName.charAt(this.fileName.length-1)=='/')this.isDir=true;if(this.uncompressedSize===g.BinaryReader.MAX_VALUE_32BITS)this.parseZIP64ExtraField(a,c);else a.skip(c);a.skip(d)};h.prototype.parseZIP64ExtraField=function(a,b){var c=0;var d=b;while(c<d){var e=a.readInt(2);var f=a.readInt(2);c+=4+f;if(e!=0x0001){a.skip(f);continue}this.uncompressedSize=a.readInt64();a.skip(f-8);this.zip64=true;break}a.skip(d-c)};h.prototype.isEncrypted=function(){return(this.bitFlag&0x0001)===0x0001};h.prototype.useUTF8=function(){return(this.bitFlag&0x0800)===0x0800};h.prototype.decodeUTF8=function(a){try{return decodeURIComponent(escape(a))}catch(e){return a}};h.prototype.decodeASCII=function(a){var i,out="",charCode,extendedASCII=['\u00C7','\u00FC','\u00E9','\u00E2','\u00E4','\u00E0','\u00E5','\u00E7','\u00EA','\u00EB','\u00E8','\u00EF','\u00EE','\u00EC','\u00C4','\u00C5','\u00C9','\u00E6','\u00C6','\u00F4','\u00F6','\u00F2','\u00FB','\u00F9','\u00FF','\u00D6','\u00DC','\u00F8','\u00A3','\u00D8','\u00D7','\u0192','\u00E1','\u00ED','\u00F3','\u00FA','\u00F1','\u00D1','\u00AA','\u00BA','\u00BF','\u00AE','\u00AC','\u00BD','\u00BC','\u00A1','\u00AB','\u00BB','_','_','_','\u00A6','\u00A6','\u00C1','\u00C2','\u00C0','\u00A9','\u00A6','\u00A6','+','+','\u00A2','\u00A5','+','+','-','-','+','-','+','\u00E3','\u00C3','+','+','-','-','\u00A6','-','+','\u00A4','\u00F0','\u00D0','\u00CA','\u00CB','\u00C8','i','\u00CD','\u00CE','\u00CF','+','+','_','_','\u00A6','\u00CC','_','\u00D3','\u00DF','\u00D4','\u00D2','\u00F5','\u00D5','\u00B5','\u00FE','\u00DE','\u00DA','\u00DB','\u00D9','\u00FD','\u00DD','\u00AF','\u00B4','\u00AD','\u00B1','_','\u00BE','\u00B6','\u00A7','\u00F7','\u00B8','\u00B0','\u00A8','\u00B7','\u00B9','\u00B3','\u00B2','_',' '];for(i=0;i<a.length;i++){charCode=a.charCodeAt(i)&0xFF;if(charCode>127)out+=extendedASCII[charCode-128];else out+=String.fromCharCode(charCode)}return out};return h})();g.ZipEntry=h})(k=j.Internal||(j.Internal={}))})(QZip||(QZip={}));var QZip;(function(f){var g=(function(){function g(a,b,c){this.zip64=false;this.files=[];this.onerror=function(e){alert(e);console.log(e)};if(typeof(c)=="function")this.onerror=c;try{if(a===undefined||a===null)throw new Error("Zip file is required.");if(a.size<=g.EOCDR_MIN)throw new Error("Invalid zip file: "+a.name);this.file=a;this.name=a.name;this.size=a.size;this.onload=b;g.writeLog("Begin reading zip file: "+this.name);this.SeekEndOfCentral()}catch(e){this.onerror(e)}}g.prototype.SeekEndOfCentral=function(){var b=this.createReader();var c=this.file.size-g.EOCDR_BUF;if(c<0)c=0;var d=this;g.writeLog("Seek start: "+c);b.onload=function(){try{if(d.CheckEndOfCentral(b.result,c))return;d.onerror(g.ERR_BAD_FORMAT+"End of Central Directory not found.")}catch(e){d.onerror(e)}};b.onerror=function(a){d.onerror(g.ERR_READ+" EOCDR I/O Error "+a)};this.openReader(b,this.file.slice(c,this.size))};g.prototype.SeekCentral=function(){var b=this.createReader();var c=this.centralDirOffset;if(this.file.size-c>g.CDR_MAX)throw new Error("There are too many entries in zip file than supported. Please reduce your zip file size.");var d=this;g.writeLog("Seek start: "+c);b.onload=function(){try{d.readCentralDir(b.result,c)}catch(e){d.onerror(e)}};b.onerror=function(a){d.onerror(g.ERR_READ+" CDR I/O Error "+a)};this.openReader(b,this.file.slice(c,this.size))};g.prototype.CheckEndOfCentral=function(a,b){this.reader=f.Internal.BinaryReader.CreateReader(a,b);var c=this.reader.lastIndexOfSignature(g.CENTRAL_DIRECTORY_END,this.reader.length-g.EOCDR_MIN,this.reader.length-g.EOCDR_MAX);if(c===-1)return false;g.writeLog("EOCDR found: "+c);this.reader.setIndex(c);this.checkSignature(g.CENTRAL_DIRECTORY_END);this.readBlockEndOfCentral();if(this.centralDirOffset===f.Internal.BinaryReader.MAX_VALUE_32BITS){this.zip64=true;g.writeLog("Zip64 detected.");c=this.reader.lastIndexOfSignature(g.ZIP64_CENTRAL_DIRECTORY_LOCATOR,c);if(c===-1){throw new Error("Corrupted zip : can't find the ZIP64 end of central directory locator");}this.reader.setIndex(c);g.writeLog("EOCDR zip64 end found: "+c);this.checkSignature(g.ZIP64_CENTRAL_DIRECTORY_LOCATOR);c=this.readBlockZip64EndOfCentralLocator();this.reader.setIndex(c,true);this.checkSignature(g.ZIP64_CENTRAL_DIRECTORY_END);this.readBlockZip64EndOfCentral()}this.SeekCentral();return true};g.prototype.readBlockEndOfCentral=function(){this.reader.skip(2+2+2+2+4);this.centralDirOffset=this.reader.readInt(4);g.writeLog("Central Dir offset: "+this.centralDirOffset)};g.prototype.readBlockZip64EndOfCentral=function(){this.reader.skip(8+2+2+4+4+8+8+8);this.centralDirOffset=this.reader.readInt64();g.writeLog("Central Dir offset zip64: "+this.centralDirOffset)};g.prototype.readBlockZip64EndOfCentralLocator=function(){var a=this.reader.readInt(4);var b=this.reader.readInt64();var c=this.reader.readInt(4);if(c>1){throw new Error("Multi-volumes zip are not supported.");}g.writeLog("EOCDR zip64 found: "+b);return b};g.prototype.readCentralDir=function(a,b){if(this.reader)this.reader.dispose();this.reader=f.Internal.BinaryReader.CreateReader(a,b);g.writeLog("Read central dir.");while(this.reader.readString(4)===g.CENTRAL_FILE_HEADER){var c=new f.Internal.ZipEntry(this.reader,this.zip64);if(!c.isDir)this.files.push(c)}if(typeof(this.onload)!="function")return;this.onload(this.files)};g.prototype.checkSignature=function(a){var b=this.reader.readString(4);if(b!==a){throw new Error("Corrupted zip or bug : unexpected signature "+"("+b+", expected "+a+")");}};g.prototype.createReader=function(){if(typeof(FileReader)==="function")return new FileReader();if(typeof(mOxie)==="object"&&typeof(mOxie.FileReader==="function"))return new mOxie.FileReader();else throw new Error("Your browser does not have FileReader.");};g.prototype.openReader=function(a,b){if(typeof(a.readAsArrayBuffer)==="function"){if(typeof(b.getSource)==="function")b=b.getSource();a.readAsArrayBuffer(b)}else if(typeof(a.readAsBinaryString)==="function"){a.readAsBinaryString(b)}else throw new Error("Your browser does not support reading binary file.");};g.writeLog=function(a){if(!g.DEBUG||typeof(console)==="undefined")return;console.log(a)};g.EOCDR_MIN=22;g.EOCDR_MAX=65558;g.EOCDR_BUF=66560;g.CDR_MAX=0xFFFFFFF;g.ERR_BAD_FORMAT="Zip file format is not recognized. ";g.ERR_READ="Error while reading zip file. ";g.DEBUG=false;g.CENTRAL_FILE_HEADER="PK\x01\x02";g.CENTRAL_DIRECTORY_END="PK\x05\x06";g.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x06\x07";g.ZIP64_CENTRAL_DIRECTORY_END="PK\x06\x06";return g})();f.ZipFile=g})(QZip||(QZip={}));